<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Заказы</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<div class="page">
    <div class="nav">
        <a href="/" class="button">Главная</a>
        <a href="/orders" class="button" th:if="${!isAdmin}">Мои заказы</a>
        <a href="/orders/new" class="button" th:if="${!isAdmin}">Бронирование</a>
        <a href="/orders/admin/all" class="button" th:if="${isAdmin}">Все заказы</a>
        <a href="/admin/panel" class="button" th:if="${isAdmin}">Админ-панель</a>
        <div id="session-info"></div>
        <a href="#" class="button" id="logout-btn">Выйти</a>
    </div>

    <div class="card">
        <h1 th:text="${isAdmin} ? 'Все заказы' : 'Мои заказы'"></h1>
        <table>
            <thead>
            <tr>
                <th>№</th>
                <th>Клиент (паспорт)</th>
                <th>Номер</th>
                <th>Класс</th>
                <th>Даты</th>
                <th>Гостей</th>
                <th>Сумма</th>
                <th>Оплата</th>
                <th>Услуги</th>
                <th th:if="${isAdmin}">Действия</th>
                <th th:if="${!isAdmin}">Действия</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="order : ${orders}">
                <td th:text="${order.orderNumber}"></td>
                <td th:text="${order.clientPassportNumber}"></td>
                <td th:text="${order.roomNumber != null && order.roomNumber != 0 ? order.roomNumber : 'Только услуга'}"></td>
                <td th:text="${orderRoomClasses != null && orderRoomClasses.containsKey(order.orderNumber) ? orderRoomClasses.get(order.orderNumber) : '—'}"></td>
                <td>
                    <span th:text="${order.checkInDate}"></span>
                    –
                    <span th:text="${order.checkOutDate}"></span>
                </td>
                <td th:text="${order.guestsCount}"></td>
                <td th:text="${orderCosts != null && orderCosts.containsKey(order.orderNumber) ? orderCosts.get(order.orderNumber) : '—'}"></td>
                <td th:text="${order.paymentStatus}"></td>
                <td>
                    <div th:if="${orderServices != null && orderServices.containsKey(order.orderNumber) && !orderServices.get(order.orderNumber).isEmpty()}">
                        <div th:each="service : ${orderServices.get(order.orderNumber)}" style="margin-bottom: 8px; padding: 4px 0;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span>
                                    <span th:text="${service.serviceName}"></span>
                                    <span th:if="${servicePrices != null && servicePrices.containsKey(service.id)}" 
                                          style="color: #059669; font-weight: 600; margin-left: 6px;">
                                        (+<span th:text="${servicePrices.get(service.id)}"></span> ₽)
                                    </span>
                                </span>
                                <form th:if="${!isAdmin}" th:action="@{'/orders/' + ${order.orderNumber} + '/services/' + ${service.id} + '/delete'}" method="post" style="display:inline;">
                                    <button type="submit" class="button" style="background: #dc2626; padding: 4px 8px; font-size: 0.8em;" onclick="return confirm('Удалить услугу?')">×</button>
                                </form>
                            </div>
                            <span th:if="${service.serviceTime != null}" style="color: #666; font-size: 0.9em; display: block;">
                                (<span th:text="${service.serviceTime}"></span>)
                            </span>
                        </div>
                    </div>
                    <span th:if="${orderServices == null || !orderServices.containsKey(order.orderNumber) || orderServices.get(order.orderNumber).isEmpty()}">—</span>
                </td>
                <td th:if="${isAdmin}">
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <a th:href="@{'/orders/' + ${order.orderNumber} + '/edit'}" class="button">Редактировать</a>
                        <form th:action="@{'/orders/' + ${order.orderNumber} + '/paid'}" method="post" style="display:inline">
                            <button type="submit" th:if="${order.paymentStatus != 'PAID'}" class="button">Отметить оплату</button>
                        </form>
                        <form th:action="@{'/orders/' + ${order.orderNumber} + '/delete'}" method="post" style="display:inline">
                            <button type="submit" class="button" style="background: #dc2626;" onclick="return confirm('Вы уверены, что хотите удалить этот заказ?')">Удалить</button>
                        </form>
                    </div>
                </td>
                <td th:if="${!isAdmin}">
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <a th:href="@{'/orders/' + ${order.orderNumber} + '/services'}" class="button">Добавить услугу</a>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>
<script src="/js/app.js"></script>
</body>
</html>


